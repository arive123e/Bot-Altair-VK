require('dotenv').config(); // üîê –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env

const TelegramBot = require('node-telegram-bot-api');

// ü§ñ –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω Telegram-–±–æ—Ç–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
const token = process.env.TELEGRAM_BOT_TOKEN;
const SUPPORT_CHAT_ID = -4927632033; // chat_id –≥—Ä—É–ø–ø—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏

if (!token) {
  console.error('‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω TELEGRAM_BOT_TOKEN –≤ .env');
  process.exit(1);
}

const bot = new TelegramBot(token, { polling: true });

// –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ (–∫—Ç–æ-–∫–æ–º—É –æ—Ç–≤–µ—á–∞–µ—Ç)
const replyContext = {};

// üéØ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  const tgId = msg.from.id;

  // ü™Ñ –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ—Ä—Ç–∞–ª –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ VK ID —Å –ø–µ—Ä–µ–¥–∞—á–µ–π tg_id
  const vkAuthUrl = `https://fokusnikaltair.xyz/vkid-auth.html?tg_id=${tgId}`;

  const welcomeText = `–ê–±—Ä–∞-–∫–∞–¥–∞–±—Ä–∞ –∏ –Ω–µ–º–Ω–æ–≥–æ –∫–æ–¥–∞ üßô‚Äç‚ôÇÔ∏è
–¢—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –≤—ã–∑–≤–∞–ª –§–æ–∫—É—Å–Ω–∏–∫–∞ –ê–ª—å—Ç–∞–∏—Ä–∞ ‚Äî —Ç–µ–ø–µ—Ä—å —Ç–≤–æ–∏ VK-–Ω–æ–≤–æ—Å—Ç–∏ —Å–∞–º–∏ –ø–µ—Ä–µ–ø–æ–ª–∑–∞—é—Ç –≤ Telegram –ø–æ –≤–æ–ª—à–µ–±—Å—Ç–≤—É, –∞ –Ω–µ –ø–æ –ø—Ä–∏—Ö–æ—Ç–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤.

–ó–∞–±—É–¥—å –ø—Ä–æ —É–Ω—ã–ª—ã–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ –ª–µ–Ω—Ç—ã, –≤–µ–¥—å —É —Ç–µ–±—è –µ—Å—Ç—å –ª–∏—á–Ω—ã–π –º–∞–≥, –∫–æ—Ç–æ—Ä—ã–π —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç –Ω–æ–≤–æ—Å—Ç–∏ –ø–æ —â–µ–ª—á–∫—É –ø–∞–ª—å—Ü–µ–≤ (–∏ –∫–ª–∏–∫—É –Ω–∞ –ø–æ—Ä—Ç–∞–ª).

–ù–µ –∑–∞–±—É–¥—å: –º–∞–≥–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —Ç–≤–æ–µ–≥–æ —É—á–∞—Å—Ç–∏—è ‚Äî –∞–∫—Ç–∏–≤–∏—Ä—É–π –ø–æ—Ä—Ç–∞–ª –∏ –Ω–∞—á–Ω–∏ –∫–æ–ª–¥–æ–≤–∞—Ç—å ‚ú® 
`;

  bot.sendMessage(chatId, welcomeText, {
    reply_markup: {
      inline_keyboard: [
        [{ text: '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä—Ç–∞–ª üåÄ', url: vkAuthUrl }]
      ]
    }
  });

  console.log(`üì® –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${tgId}`);
});

// üëá –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /support (–∏–ª–∏ –∫–Ω–æ–ø–∫–∞ "–°–≤—è–∑–∞—Ç—å—Å—è —Å –º–∞–≥–∏—Å—Ç—Ä–æ–º –±–æ—Ç–∞")
bot.onText(/\/support/, (msg) => {
  bot.sendMessage(msg.chat.id, "–ï—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å, –ø–æ–∂–µ–ª–∞–Ω–∏–µ –∏–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –æ–ø–∏—à–∏ –ø—Ä–æ–±–ª–µ–º—É –≤ —Å–ª–µ–¥—É—é—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏! –ú–∞–≥–∏—Å—Ç—Ä –ø—Ä–æ—á–∏—Ç–∞–µ—Ç –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç. –¢–≤–æ–π Telegram –Ω–∏–∫ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è —Å–∫—Ä—ã—Ç, –∞ –º–∞–≥–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —É–∂–µ —Ä—è–¥–æ–º! ‚úâÔ∏è");
});

// üëá –ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å –∫–Ω–æ–ø–∫–æ–π "–û—Ç–≤–µ—Ç–∏—Ç—å"
bot.on('message', (msg) => {
  // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —Å–∞–º–æ–π –≥—Ä—É–ø–ø—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏, –∫–æ–º–∞–Ω–¥—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞
  if (
    msg.chat.id === SUPPORT_CHAT_ID ||
    (msg.text && msg.text.startsWith('/')) ||
    msg.from.is_bot
  ) return;

  // –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º –≤ –≥—Ä—É–ø–ø—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏
  bot.sendMessage(SUPPORT_CHAT_ID,
    `üßô –í–æ–ø—Ä–æ—Å –æ—Ç @${msg.from.username || msg.from.id} (ID: ${msg.from.id}):\n${msg.text}`, {
      reply_markup: {
        inline_keyboard: [
          [{
            text: "–û—Ç–≤–µ—Ç–∏—Ç—å",
            callback_data: `reply_${msg.from.id}`
          }]
        ]
      }
    }
  );
});

// üëá –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–û—Ç–≤–µ—Ç–∏—Ç—å"
bot.on('callback_query', async (query) => {
  const data = query.data;

  if (data.startsWith('reply_')) {
    const userId = data.split('_')[1];

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º, –∫–æ–º—É –±—É–¥–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π –æ—Ç–≤–µ—Ç —ç—Ç–æ–≥–æ –º–∞–≥–∏—Å—Ç—Ä–∞
    replyContext[query.from.id] = userId;

    // –ë–æ—Ç –ø–∏—à–µ—Ç –º–∞–≥–∏—Å—Ç—Ä—É –≤ –ª–∏—á–∫—É (Telegram!)
    await bot.sendMessage(
      query.from.id, 
      `‚úçÔ∏è –ù–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –æ—Ç–≤–µ—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (ID: ${userId}), –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.`
    );

    await bot.answerCallbackQuery(query.id, { text: '–ñ–¥—É –≤–∞—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞!' });
  }
});

// üëá –ü–µ—Ä–µ–¥–∞—á–∞ –æ—Ç–≤–µ—Ç–∞ –º–∞–≥–∏—Å—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
bot.on('message', (msg) => {
  // –ï—Å–ª–∏ –µ—Å—Ç—å –æ–∂–∏–¥–∞—é—â–∏–π –æ—Ç–≤–µ—Ç–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —ç—Ç–æ –ª–∏—á–∫–∞ –º–∞–≥–∏—Å—Ç—Ä–∞
  if (replyContext[msg.from.id] && msg.chat.type === 'private') {
    const targetUserId = replyContext[msg.from.id];

    bot.sendMessage(
      targetUserId,
      `üßô –ú–∞–≥–∏—Å—Ç—Ä –±–æ—Ç–∞ –æ—Ç–≤–µ—á–∞–µ—Ç:\n${msg.text}`
    );

    bot.sendMessage(
      msg.chat.id,
      "‚úÖ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é!"
    );

    // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞
    delete replyContext[msg.from.id];
  }
});
